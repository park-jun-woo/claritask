# Plan: í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ë™ì‹œ ì²˜ë¦¬ ê°œì„ 

**ë‚ ì§œ**: 2026-02-05
**ìƒíƒœ**: Draft
**ì˜í–¥ ë²”ìœ„**: telegram.go, tghandler.go, router.go

---

## 1. ë¬¸ì œ ìš”ì•½

í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ê°€ ë™ì‹œì— 2ê°œ ì´ìƒ ì²˜ë¦¬ë˜ì§€ ì•ŠëŠ” ë¬¸ì œ. ê·¼ë³¸ ì›ì¸ì€ 3ê°€ì§€:

| # | ë¬¸ì œ | ìœ„ì¹˜ | ì‹¬ê°ë„ |
|---|------|------|--------|
| A | í…”ë ˆê·¸ë¨ ìˆ˜ì‹  ë£¨í”„ì—ì„œ handler ë™ê¸° í˜¸ì¶œ | telegram.go:240 | ğŸ”´ ë†’ìŒ |
| B | Routerê°€ ì „ì—­ Contextë¥¼ ê³µìœ  (race condition) | router.go:26-29 | ğŸ”´ ë†’ìŒ |
| C | task cycle/RunAllì´ ì„¸ë§ˆí¬ì–´ë¥¼ ìˆœì°¨ ë…ì  | cycle.go, run.go | ğŸŸ¡ ì¤‘ê°„ |

---

## 2. í•´ê²° ë°©ì•ˆ

### 2-1. í…”ë ˆê·¸ë¨ ìˆ˜ì‹  ë£¨í”„ ë¹„ë™ê¸°í™” (ë¬¸ì œ A)

**í˜„ì¬ ì½”ë“œ** (`telegram.go:240`):
```go
b.handler(msg)  // ë™ê¸° í˜¸ì¶œ â†’ í•¸ë“¤ëŸ¬ ë¦¬í„´ê¹Œì§€ ë‹¤ìŒ ë©”ì‹œì§€ ì²˜ë¦¬ ë¶ˆê°€
```

**ë³€ê²½ ë°©ì•ˆ**:
```go
go b.handler(msg)  // ë¹„ë™ê¸° í˜¸ì¶œ
```

ì½œë°± í•¸ë“¤ëŸ¬ë„ ë™ì¼í•˜ê²Œ ì ìš©:
```go
go b.callbackHandler(cb)  // ë¹„ë™ê¸° í˜¸ì¶œ
```

**ì¥ì **: ìˆ˜ì‹  ë£¨í”„ê°€ ì ˆëŒ€ ë¸”ë¡œí‚¹ë˜ì§€ ì•ŠìŒ
**ë¦¬ìŠ¤í¬**: handler ë‚´ë¶€ì˜ ë™ì‹œì„± ì•ˆì „ì„± í•„ìš” â†’ 2-2ì—ì„œ í•´ê²°

---

### 2-2. Router ìš”ì²­ë³„ Context ê²©ë¦¬ (ë¬¸ì œ B)

**í˜„ì¬ êµ¬ì¡°**: Router 1ê°œ â†’ Context 1ê°œ (ì „ì—­ ìƒíƒœ)
```go
type Router struct {
    ctx      *Context  // â† ëª¨ë“  ìš”ì²­ì´ ê³µìœ 
    pageSize int
}
```

**ë³€ê²½ ë°©ì•ˆ**: Executeì— Contextë¥¼ ì¸ìë¡œ ì „ë‹¬

#### Step 1: Execute ì‹œê·¸ë‹ˆì²˜ ë³€ê²½

```go
// ê¸°ì¡´
func (r *Router) Execute(input string) types.Result

// ë³€ê²½
func (r *Router) Execute(ctx *Context, input string) types.Result
```

ëª¨ë“  í•˜ìœ„ í•¸ë“¤ëŸ¬ë„ Contextë¥¼ ì¸ìë¡œ ë°›ë„ë¡ ë³€ê²½:
```go
func (r *Router) handleTask(ctx *Context, cmd string, args []string) types.Result
func (r *Router) handleMessage(ctx *Context, cmd string, args []string) types.Result
func (r *Router) handleEdge(ctx *Context, cmd string, args []string) types.Result
func (r *Router) handleSchedule(ctx *Context, cmd string, args []string) types.Result
func (r *Router) handleStatus(ctx *Context) types.Result
func (r *Router) handleClaude(ctx *Context, input string) types.Result
```

#### Step 2: Routerì— í˜„ì¬ Contextë¥¼ ìŠ¤ëƒ…ìƒ·í•˜ëŠ” ë©”ì„œë“œ ì¶”ê°€

```go
func (r *Router) SnapshotContext() *Context {
    r.mu.RLock()
    defer r.mu.RUnlock()
    return &Context{
        ProjectID:          r.ctx.ProjectID,
        ProjectPath:        r.ctx.ProjectPath,
        ProjectDescription: r.ctx.ProjectDescription,
    }
}
```

#### Step 3: SetProjectì— mutex ì¶”ê°€

```go
type Router struct {
    ctx      *Context
    mu       sync.RWMutex  // â† ì¶”ê°€
    pageSize int
}

func (r *Router) SetProject(id, path, desc string) {
    r.mu.Lock()
    defer r.mu.Unlock()
    r.ctx.ProjectID = id
    r.ctx.ProjectPath = path
    r.ctx.ProjectDescription = desc
}

func (r *Router) GetProject() (string, string) {
    r.mu.RLock()
    defer r.mu.RUnlock()
    return r.ctx.ProjectID, r.ctx.ProjectPath
}
```

#### Step 4: í˜¸ì¶œë¶€ ìˆ˜ì •

**tghandler.go** - ë¹„ë™ê¸° í˜¸ì¶œ ì‹œ ì»¨í…ìŠ¤íŠ¸ ìŠ¤ëƒ…ìƒ·:
```go
// ê¸°ì¡´
go func() {
    result := h.router.Execute(cmd)
    h.sendReport(msg.ChatID, result)
}()

// ë³€ê²½
snapshot := h.router.SnapshotContext()
go func() {
    result := h.router.Execute(snapshot, cmd)
    h.sendReport(msg.ChatID, result)
}()
```

**ë™ê¸° í˜¸ì¶œë„ ìŠ¤ëƒ…ìƒ· ì‚¬ìš©**:
```go
// ê¸°ì¡´
result := h.router.Execute(cmd)

// ë³€ê²½
snapshot := h.router.SnapshotContext()
result := h.router.Execute(snapshot, cmd)
```

**CLI handler (main.go)** ë„ ë™ì¼:
```go
snapshot := router.SnapshotContext()
result := router.Execute(snapshot, cmdStr)
```

**Schedule ì‹¤í–‰** ì—ì„œë„ í”„ë¡œì íŠ¸ ê²½ë¡œë¥¼ ì§ì ‘ ì „ë‹¬í•˜ë¯€ë¡œ ë³„ë„ Context ìƒì„±:
```go
ctx := &handler.Context{
    ProjectID:   projectID,
    ProjectPath: projectPath,
}
result := router.Execute(ctx, msg)
```

#### Step 5: project switch ë“± ìƒíƒœ ë³€ê²½ ëª…ë ¹ì–´ ì²˜ë¦¬

`project switch`, `project add`, `project create` ë“±ì€ Execute ë‚´ë¶€ì—ì„œ Routerì˜ ì „ì—­ Contextë¥¼ ë³€ê²½í•´ì•¼ í•¨:

```go
func (r *Router) handleProject(ctx *Context, cmd string, args []string) types.Result {
    // ...
    case "switch":
        result := project.Switch(args[0])
        if result.Success {
            if p, ok := result.Data.(*project.Project); ok {
                r.SetProject(p.ID, p.Path, p.Description)  // ì „ì—­ ìƒíƒœ ë³€ê²½ (mutex ë³´í˜¸)
            }
        }
        return result
}
```

project switchëŠ” ì „ì—­ Contextë¥¼ ë³€ê²½í•˜ëŠ” ìœ ì¼í•œ ëª…ë ¹êµ°ì´ë¯€ë¡œ, ì´ ë¶€ë¶„ì€ Routerì˜ SetProject(mutex ë³´í˜¸)ì„ í†µí•´ ì•ˆì „í•˜ê²Œ ë³€ê²½.

---

### 2-3. Send("ì²˜ë¦¬ ì¤‘...") ë¹„ë™ê¸°í™” (ë¬¸ì œ A ë³´ì™„)

**í˜„ì¬ ì½”ë“œ** (`tghandler.go:195`):
```go
h.bot.Send(msg.ChatID, "ì²˜ë¦¬ ì¤‘...")  // ë™ê¸° (retry í¬í•¨ ìµœëŒ€ 7ì´ˆ)
go func() {
    result := h.router.Execute(cmd)
    h.sendReport(msg.ChatID, result)
}()
```

ìˆ˜ì‹  ë£¨í”„ë¥¼ ë¹„ë™ê¸°í™”(2-1)í•˜ë©´ ì´ ë¬¸ì œëŠ” ìë™ í•´ê²°ë¨. í•¸ë“¤ëŸ¬ ìì²´ê°€ goroutineì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ Send ë¸”ë¡œí‚¹ì´ ìˆ˜ì‹  ë£¨í”„ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŒ.

ë”°ë¼ì„œ **ì¶”ê°€ ë³€ê²½ ë¶ˆí•„ìš”**.

---

### 2-4. task cycle/RunAll ì„¸ë§ˆí¬ì–´ ë…ì  ë°©ì§€ (ë¬¸ì œ C)

**í˜„ì¬ ë¬¸ì œ**: task cycleì´ PlanAll â†’ RunAllì„ ìˆœì°¨ ì‹¤í–‰í•˜ë©°, ê° taskë§ˆë‹¤ claude.Run()ì„ í˜¸ì¶œ. Nê°œ taskê°€ ìˆìœ¼ë©´ ì„¸ë§ˆí¬ì–´ë¥¼ Në²ˆ ìˆœì°¨ ì ìœ .

**í˜„ì¬ ìš°ì„ ìˆœìœ„**: ğŸŸ¡ ë‚®ìŒ (í˜„ì¬ëŠ” ë‹¨ì¼ ì‚¬ìš©ìì´ë¯€ë¡œ ì‹¤ì§ˆì  ë¬¸ì œ ì—†ìŒ)

**í–¥í›„ ê°œì„  ë°©í–¥** (ì´ë²ˆ PR ë²”ìœ„ ì™¸):
- PlanAll/RunAllì—ì„œ goroutine pool íŒ¨í„´ìœ¼ë¡œ ë³‘ë ¬ ì‹¤í–‰
- ë˜ëŠ” ì„¸ë§ˆí¬ì–´ ìŠ¬ë¡¯ ì¤‘ 1ê°œë¥¼ ì¼ë°˜ ë©”ì‹œì§€ìš©ìœ¼ë¡œ ì˜ˆì•½

---

## 3. êµ¬í˜„ ìˆœì„œ

| ë‹¨ê³„ | ì‘ì—… | íŒŒì¼ | ë‚œì´ë„ |
|------|------|------|--------|
| 1 | Routerì— mutex ì¶”ê°€, SnapshotContext êµ¬í˜„ | router.go | ë‚®ìŒ |
| 2 | Execute ì‹œê·¸ë‹ˆì²˜ ë³€ê²½ (`ctx *Context` ì¸ì ì¶”ê°€) | router.go | ì¤‘ê°„ |
| 3 | ëª¨ë“  í•˜ìœ„ í•¸ë“¤ëŸ¬ì— ctx ì¸ì ì „ë‹¬ | router.go | ì¤‘ê°„ (ê¸°ê³„ì ) |
| 4 | tghandler.goì—ì„œ ìŠ¤ëƒ…ìƒ· ê¸°ë°˜ í˜¸ì¶œë¡œ ë³€ê²½ | tghandler.go | ë‚®ìŒ |
| 5 | CLI handlerì—ì„œ ìŠ¤ëƒ…ìƒ· ê¸°ë°˜ í˜¸ì¶œë¡œ ë³€ê²½ | main.go | ë‚®ìŒ |
| 6 | í…”ë ˆê·¸ë¨ ìˆ˜ì‹  ë£¨í”„ ë¹„ë™ê¸°í™” (`go b.handler`) | telegram.go | ë‚®ìŒ |
| 7 | ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ | - | - |

---

## 4. ë³€ê²½ íŒŒì¼ ëª©ë¡

| íŒŒì¼ | ë³€ê²½ ë‚´ìš© |
|------|----------|
| `bot/pkg/telegram/telegram.go` | handler, callbackHandlerë¥¼ `go` í‚¤ì›Œë“œë¡œ ë¹„ë™ê¸° í˜¸ì¶œ |
| `bot/internal/handler/router.go` | mutex ì¶”ê°€, SnapshotContext, Execute/í•¸ë“¤ëŸ¬ ì‹œê·¸ë‹ˆì²˜ ë³€ê²½ |
| `bot/internal/tghandler/tghandler.go` | ìŠ¤ëƒ…ìƒ· ê¸°ë°˜ Execute í˜¸ì¶œ |
| `bot/cmd/claribot/main.go` | ìŠ¤ëƒ…ìƒ· ê¸°ë°˜ Execute í˜¸ì¶œ |

---

## 5. ê²€ì¦ ë°©ë²•

1. **ë™ì‹œ ë©”ì‹œì§€ ì²˜ë¦¬**: í…”ë ˆê·¸ë¨ì—ì„œ ë¹ ë¥´ê²Œ 2-3ê°œ ë©”ì‹œì§€ ì—°ì† ì „ì†¡ â†’ ëª¨ë‘ "ì²˜ë¦¬ ì¤‘..." ì¦‰ì‹œ ì‘ë‹µ í™•ì¸
2. **í”„ë¡œì íŠ¸ ê²©ë¦¬**: project A ì„ íƒ í›„ task list ìš”ì²­ ì¤‘ project Bë¡œ switch â†’ ê°ê° ì˜¬ë°”ë¥¸ í”„ë¡œì íŠ¸ ê²°ê³¼ ë°˜í™˜ í™•ì¸
3. **Race condition**: `-race` í”Œë˜ê·¸ë¡œ ë¹Œë“œ í›„ ë™ì‹œ ìš”ì²­ í…ŒìŠ¤íŠ¸
4. **Quick command ë³‘ë ¬**: task listì™€ statusë¥¼ ë™ì‹œ ìš”ì²­ â†’ ë‘˜ ë‹¤ ì¦‰ì‹œ ì‘ë‹µ

---

## 6. ë¦¬ìŠ¤í¬

| ë¦¬ìŠ¤í¬ | ëŒ€ì‘ |
|--------|------|
| ê¸°ì¡´ CLI í˜¸ì¶œë¶€ ëˆ„ë½ | grepìœ¼ë¡œ Execute í˜¸ì¶œë¶€ ì „ìˆ˜ ê²€ìƒ‰ |
| project switch íƒ€ì´ë° ì´ìŠˆ | mutexë¡œ ë³´í˜¸, ìŠ¤ëƒ…ìƒ· ì‹œì ì˜ Context ì‚¬ìš© |
| goroutine ê³¼ë‹¤ ìƒì„± | í…”ë ˆê·¸ë¨ ë´‡ íŠ¹ì„±ìƒ ì´ˆë‹¹ ìˆ˜ì‹­ ë©”ì‹œì§€ ë¶ˆê°€, ë¬¸ì œ ì—†ìŒ |
