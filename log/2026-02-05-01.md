# Claribot 개발 로그 - 2026-02-05

## 작업 내용

### 1. Task 시스템 구현 (Phase 1-5)

docs/Task.md 설계에 따라 2-pass 순회 시스템 구현

#### Phase 1: 스키마 마이그레이션
- `tasks` 테이블 스키마 변경: `content` → `spec`, `result` → `report`, `plan` 필드 추가
- 상태 모델 변경: `pending/running/done` → `spec_ready/plan_ready/done`
- Task 구조체 및 CRUD 함수 수정

#### Phase 2: 연관 Task 조회
- `related.go` 생성
  - `GetRelated()` - Edge/Parent/Child 연결된 Task 조회
  - `GetRelatedSpecs()` - 연관 Task의 spec 조회 (1회차용)
  - `GetRelatedPlans()` - 연관 Task의 plan 조회 (2회차용)

#### Phase 3: 1회차 순회 (Plan 생성)
- `prompt.go` - 프롬프트 생성 함수
  - `BuildPlanPrompt()` - Plan 생성 프롬프트
  - `BuildExecutePrompt()` - 실행 프롬프트
- `plan.go` - Plan 생성 로직
  - `Plan()` - 단일 Task Plan 생성
  - `PlanAll()` - 전체 spec_ready Task Plan 생성
- `task plan [id]`, `task plan --all` 명령어 추가

#### Phase 4: 2회차 순회 (실행)
- `run.go` 수정 - Claude Code 연동
  - `Run()` - 단일 Task 실행
  - `RunAll()` - 전체 plan_ready Task 실행
- `task run --all` 옵션 추가

#### Phase 5: 자동화
- `cycle.go` - 전체 순회 실행
  - `Cycle()` - 1회차 + 2회차 자동 실행
- `task cycle` 명령어 추가
- docs/Task.md 업데이트

### 2. 테스트 작성
- `task_test.go` - Task CRUD 테스트
- `related_test.go` - 연관 Task 조회 테스트

### 3. 에러 로그 추가

텔레그램 응답 전송 실패 문제 분석 후 에러 로깅 추가

- `tghandler/tghandler.go`
  - `sendResult()`, `sendReport()` - 텔레그램 전송 실패 로그
- `task/plan.go`, `task/run.go` - DB 업데이트 에러 로그
- `message/send.go` - DB 업데이트 에러 로그

### 4. Schedule 시스템 구현

스케줄링 기능 추가 (자체 루틴 방식, robfig/cron 라이브러리 사용)

#### 설계 문서
- `docs/Schedule.md` 작성

#### 구현 파일
- `internal/schedule/schedule.go` - Schedule, ScheduleRun 구조체
- `internal/schedule/add.go` - 스케줄 추가
- `internal/schedule/get.go` - 스케줄 조회
- `internal/schedule/list.go` - 스케줄 목록
- `internal/schedule/delete.go` - 스케줄 삭제
- `internal/schedule/toggle.go` - 활성화/비활성화
- `internal/schedule/scheduler.go` - cron 매니저 + Claude Code 실행
- `internal/schedule/runs.go` - 실행 기록 조회

#### CLI 명령어
```bash
schedule add "0 7 * * *" "메시지"      # 스케줄 추가
schedule list [--all]                   # 스케줄 목록
schedule get <id>                       # 스케줄 조회
schedule delete <id>                    # 스케줄 삭제
schedule enable <id>                    # 활성화
schedule disable <id>                   # 비활성화
schedule runs <schedule_id>             # 실행 기록 목록
schedule run <run_id>                   # 실행 기록 상세
```

#### DB 스키마
```sql
-- 스케줄 정의
CREATE TABLE schedules (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id TEXT,
    cron_expr TEXT NOT NULL,
    message TEXT NOT NULL,
    enabled INTEGER DEFAULT 1,
    last_run TEXT,
    next_run TEXT,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);

-- 실행 결과 저장
CREATE TABLE schedule_runs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    schedule_id INTEGER NOT NULL,
    status TEXT DEFAULT 'running'
        CHECK(status IN ('running', 'done', 'failed')),
    result TEXT DEFAULT '',
    error TEXT DEFAULT '',
    started_at TEXT NOT NULL,
    completed_at TEXT,
    FOREIGN KEY (schedule_id) REFERENCES schedules(id) ON DELETE CASCADE
);
```

#### 실행 흐름
1. cron 트리거 발생
2. `schedule_runs`에 'running' 상태로 레코드 생성
3. 해당 프로젝트 경로에서 Claude Code 실행
4. 결과(보고서)를 `schedule_runs.result`에 저장
5. status를 'done' 또는 'failed'로 업데이트
6. 텔레그램으로 결과 알림 전송

#### 기타 변경
- `pkg/telegram/telegram.go` - `Broadcast()` 함수 추가
- `cmd/claribot/main.go` - Scheduler 초기화/종료 추가
- `db.go` - schedules, schedule_runs 테이블 추가

## 파일 변경 목록

### 신규 파일
- `docs/Task.md` (업데이트)
- `docs/Schedule.md`
- `internal/task/related.go`
- `internal/task/prompt.go`
- `internal/task/plan.go`
- `internal/task/cycle.go`
- `internal/task/task_test.go`
- `internal/task/related_test.go`
- `internal/schedule/schedule.go`
- `internal/schedule/add.go`
- `internal/schedule/get.go`
- `internal/schedule/list.go`
- `internal/schedule/delete.go`
- `internal/schedule/toggle.go`
- `internal/schedule/scheduler.go`
- `internal/schedule/runs.go`

### 수정 파일
- `internal/db/db.go` - tasks, schedules 스키마
- `internal/task/task.go` - 구조체
- `internal/task/add.go` - status, updated_at
- `internal/task/get.go` - 필드명
- `internal/task/list.go` - statusToIcon
- `internal/task/set.go` - 허용 필드/상태
- `internal/task/run.go` - Claude 연동
- `internal/handler/router.go` - schedule 명령어
- `internal/tghandler/tghandler.go` - 에러 로그
- `internal/message/send.go` - 에러 로그
- `pkg/telegram/telegram.go` - Broadcast
- `cmd/claribot/main.go` - Scheduler 초기화

## 다음 작업
- Schedule 기능 실제 실행 테스트
- 서비스 재시작 후 cron 트리거 확인
